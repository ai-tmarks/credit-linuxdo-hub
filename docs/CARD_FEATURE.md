# 发卡功能设计文档

## 功能概述

用户打赏后自动发放卡密（激活码、邀请码、资源链接等），支持限量销售。

## 发卡模式

系统支持三种发卡模式，满足不同的销售场景：

### 一对一模式（默认）

每个卡密只能卖给一个人，适用于：
- 软件激活码
- 邀请码
- 一次性使用的资源

库存 = 卡密数量，卖完即止。

### 一对多模式

同一个卡密可以卖给多人，适用于：
- 网盘链接
- 教程资源
- 共享账号
- 任何可重复使用的内容

库存无限，所有买家获得相同的卡密内容。

### 多对多模式

每次购买发放多个卡密，适用于：
- 套餐销售（如：3个激活码套餐）
- 批量资源（如：10个邀请码）
- 组合商品

库存 = 卡密总数 ÷ 每单发放数量

## 使用场景

- 出售软件激活码
- 出售邀请码
- 出售网盘资源链接
- 出售任何文本形式的虚拟商品

## 核心流程

### 商家流程

1. 创建发卡链接
   - 设置商品标题和描述
   - 设置单价（积分）
   - 选择发卡模式（一对一/一对多/多对多）
   - 批量导入卡密内容
   - 多对多模式需设置每单发放数量

2. 分享链接
   - 获取专属链接
   - 分享到 Linux Do 社区

3. 管理卡密
   - 查看已售出/未售出数量
   - 查看购买记录
   - 补充卡密库存
   - 关闭/开启销售

### 买家流程

1. 点击购买链接
2. 查看商品信息和剩余库存
3. 确认支付（跳转 credit.linux.do）
4. 支付成功后自动获得卡密
5. 在成功页面查看/复制卡密

## 功能特性

### 库存管理

- 设置总库存数量
- 库存为0时自动关闭购买入口
- 支持随时补充库存
- 支持手动关闭/开启销售

### 卡密管理

- 批量导入卡密（每行一个）
- 每个卡密只能被领取一次
- 支持查看卡密状态（未售出/已售出）
- 已售出的卡密显示购买者信息和时间

### 购买限制

- 可设置每人限购数量（如：每人最多买1个）
- 可设置最低信任等级要求
- 库存售罄自动停止销售

### 订单记录

- 记录每笔交易的购买者信息
- 记录支付时间和金额
- 记录发放的卡密内容
- 支持导出订单记录

## 页面设计

### 创建发卡链接页面

商家在后台创建发卡链接，需要填写：

- 商品标题（必填）
- 商品描述（可选，支持简单说明）
- 单价（必填，积分数量）
- 发卡模式（一对一/一对多/多对多）
- 每单发放数量（多对多模式时显示）
- 卡密列表（必填，文本框批量输入，每行一个）
- 每人限购（可选，默认不限）
- 最低信任等级（可选，默认0）

### 购买页面

买家看到的页面，显示：

- 商品标题和描述
- 单价
- 剩余库存
- 购买按钮（库存为0时显示"已售罄"）

### 支付成功页面

支付完成后显示：

- 购买成功提示
- 卡密内容（突出显示，支持一键复制）
- 使用说明（如果商家设置了）
- 返回按钮

### 管理页面

商家后台管理，显示：

- 商品列表
- 每个商品的销售统计（已售/总量）
- 收入统计
- 操作按钮（查看详情、补充库存、关闭销售）

### 商品详情页面

点击商品进入详情，显示：

- 基本信息
- 卡密列表（状态、购买者、时间）
- 订单记录
- 补充卡密入口

## 数据结构

### 发卡链接表

存储发卡链接的基本信息：

- 链接ID
- 创建者ID
- 短码（用于生成链接）
- 商品标题
- 商品描述
- 单价
- 总库存
- 已售数量
- 每人限购数量
- 最低信任等级
- 发卡模式（one_to_one/one_to_many/multi）
- 每单发放数量（多对多模式使用）
- 是否启用
- 创建时间
- 更新时间

### 卡密表

存储所有卡密：

- 卡密ID
- 所属链接ID
- 卡密内容
- 状态（未售出/已售出）
- 购买者ID（售出后填写）
- 购买者用户名
- 售出时间
- 订单号
- 创建时间

### 订单表

存储购买记录：

- 订单ID
- 链接ID
- 购买者ID
- 购买者用户名
- 支付金额
- 卡密ID
- 支付平台订单号
- 支付时间
- 创建时间

## 安全考虑

### 防止重复领取

- 支付回调使用订单号去重
- 同一订单号只发放一次卡密
- 数据库层面保证卡密唯一性

### 防止超卖

- 领取卡密时使用数据库事务
- 先锁定卡密再更新状态
- 库存检查和扣减原子操作

### 卡密保护

- 卡密内容只在支付成功后显示
- 不在列表页暴露完整卡密
- 管理页面可选择是否显示完整卡密

## 与现有功能的关系

### 与打赏链接的区别

| 特性 | 打赏链接 | 发卡链接 |
|------|---------|---------|
| 目的 | 接受打赏 | 销售虚拟商品 |
| 金额 | 可自定义 | 固定单价 |
| 数量 | 无限制 | 有库存限制 |
| 回报 | 无 | 自动发放卡密 |
| 统计 | 总收款金额 | 销量和收入 |

### 复用现有组件

- 复用现有的支付流程（易支付接口）
- 复用现有的回调处理逻辑
- 复用现有的用户认证系统
- 复用现有的 UI 组件库

## 后续扩展

### 可能的增强功能

- 支持设置有效期（过期自动下架）
- 支持优惠码/折扣
- 支持批量购买（一次买多个）
- 支持自动补货（对接外部 API）
- 支持 Webhook 通知（售出时通知商家）
- 支持评价系统

### 数据统计

- 销售趋势图表
- 热门商品排行
- 买家分析
- 收入报表
